## 监视网页更改脚本

**test.py**

```
#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import requests
import hashlib
import time
import os
import logging
import sys
from datetime import datetime
import threading
import subprocess

# 引入状态栏图标需要的库
import pystray
from PIL import Image, ImageDraw
from win10toast import ToastNotifier

# 配置日志
LOG_FILE = "website_monitor.log"
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler(LOG_FILE),
        logging.StreamHandler()
    ]
)

# 网站监控配置
URL = "https://www.iie.ac.cn/xsjy2020/zxtz2020/"
CHECK_INTERVAL = 30 * 60  # 检查间隔，默认30分钟

# 全局变量，用于控制监控线程
running = True


def get_page_content(url):
    """获取网页内容"""
    headers = {
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/99.0.9999.99 Safari/537.36"
    }
    try:
        response = requests.get(url, headers=headers, timeout=30)
        response.raise_for_status()  # 检查请求是否成功
        return response.text
    except Exception as e:
        logging.error(f"获取网页内容失败: {e}")
        return None


def calculate_hash(content):
    """计算内容的哈希值"""
    if content:
        return hashlib.md5(content.encode('utf-8')).hexdigest()
    return None


def save_hash(hash_value):
    """保存哈希值到文件"""
    with open("last_hash.txt", "w") as f:
        f.write(hash_value)


def load_hash():
    """从文件加载哈希值"""
    try:
        with open("last_hash.txt", "r") as f:
            return f.read().strip()
    except FileNotFoundError:
        return None


def send_desktop_notification():
    """发送桌面通知"""
    try:
        toaster = ToastNotifier()
        toaster.show_toast(
            "信息工程研究所复试公告更新",
            f"检测到页面更新，请访问网站查看最新信息",
            duration=10,
            threaded=True  # 使用线程避免阻塞
        )
        logging.info("已发送Windows桌面通知")
        return True
    except Exception as e:
        logging.error(f"桌面通知发送失败: {e}")
        return False


def create_icon():
    """创建系统托盘图标"""
    # 创建一个简单的图标
    width = 64
    height = 64
    color1 = (255, 255, 255)  # 白色
    color2 = (0, 120, 212)  # 蓝色

    image = Image.new('RGB', (width, height), color1)
    dc = ImageDraw.Draw(image)

    # 绘制一个简单的图标
    dc.rectangle([(16, 16), (width - 16, height - 16)], fill=color2)
    dc.ellipse([(20, 20), (width - 20, height - 20)], fill=color1)

    return image


def exit_action(icon):
    """退出程序"""
    global running
    running = False
    icon.stop()
    sys.exit(0)


def view_log(icon):
    """使用记事本打开日志文件"""
    try:
        # 获取日志文件的绝对路径
        log_path = os.path.abspath(LOG_FILE)
        logging.info(f"正在打开日志文件: {log_path}")
        
        # 使用默认应用程序(notepad)打开日志文件
        if os.name == 'nt':  # Windows
            os.startfile(log_path)
        else:  # 其他操作系统
            opener = 'notepad' if os.name == 'nt' else 'open' if sys.platform == 'darwin' else 'xdg-open'
            subprocess.call([opener, log_path])
    except Exception as e:
        logging.error(f"打开日志文件失败: {e}")


def check_website_updates():
    """检查网站更新的主函数"""
    global running

    logging.info("开始监控信息工程研究所复试公告页面...")
    logging.info(f"监控网址: {URL}")
    logging.info(f"检查间隔: {CHECK_INTERVAL // 60} 分钟")

    last_hash = load_hash()
    if not last_hash:
        # 首次运行，获取当前页面内容的哈希值
        content = get_page_content(URL)
        if content:
            current_hash = calculate_hash(content)
            save_hash(current_hash)
            logging.info("首次运行，已保存当前页面哈希值")
        else:
            logging.error("首次获取页面内容失败，请检查网络连接或URL是否正确")
            return

    while running:
        try:
            logging.info("正在检查页面更新...")
            content = get_page_content(URL)

            if not content:
                logging.warning("获取页面内容失败，将在下次检查时重试")
                time.sleep(CHECK_INTERVAL)
                continue

            current_hash = calculate_hash(content)
            last_hash = load_hash()

            if current_hash != last_hash:
                logging.info("检测到页面更新！")
                save_hash(current_hash)

                # 发送桌面通知
                send_desktop_notification()

                # 打印更新提示（如果是在终端运行）
                print("\n" + "=" * 50)
                print("检测到信息工程研究所复试公告页面有更新！")
                print(f"请访问 {URL} 查看最新信息")
                print("=" * 50 + "\n")
            else:
                logging.info("未检测到更新")

            # 等待到下次检查
            logging.info(f"将在 {CHECK_INTERVAL // 60} 分钟后再次检查")

            # 分段睡眠，便于退出检测
            for _ in range(CHECK_INTERVAL // 10):
                if not running:
                    break
                time.sleep(10)

        except Exception as e:
            logging.error(f"检查过程中发生错误: {e}")
            time.sleep(60)  # 出错后等待一分钟再重试


def open_website(icon):
    """打开监控的网站"""
    import webbrowser
    webbrowser.open(URL)


def main():
    """主函数"""
    # 创建并启动监控线程
    monitor_thread = threading.Thread(target=check_website_updates)
    monitor_thread.daemon = True
    monitor_thread.start()

    # 创建系统托盘图标
    icon = pystray.Icon("IIEMonitor")
    icon.icon = create_icon()
    icon.title = "信息工程研究所复试公告监控"

    # 创建菜单项（添加查看日志选项）
    icon.menu = pystray.Menu(
        pystray.MenuItem("打开公告网页", open_website),
        pystray.MenuItem("查看日志", view_log),
        pystray.MenuItem("退出", exit_action)
    )

    # 运行系统托盘图标（这会阻塞主线程）
    icon.run()


if __name__ == "__main__":
    main()
```

#### 可选win10：

**start_monitor.bat**

```
@echo off
:: 隐藏命令行窗口运行Python脚本
start /min "" pythonw "监控脚本完路径\test.py"
exit
```

**设置开机自启**

```
按下 Win + R 组合键，打开运行对话框
输入 shell:startup 并按Enter，打开启动文件夹
将 start_monitor.bat 复制到该文件夹中
```



